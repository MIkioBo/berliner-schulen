"use strict";var sp=sp||{};!function(a,b){function c(){b.ajax({url:"config.json",async:!1}).done(function(a){sp.config=a})}function d(){c()}d()}(window,window.jQuery),angular.module("berlinerSchulenApp",["leaflet-directive","ui.router","ngMaterial","lumx"]),angular.module("berlinerSchulenApp").config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/"),a.state("index",{url:"/",views:{view1:{templateUrl:"filterAndMap/filterAndMap.html"},view2:{controller:"ListCtrl",templateUrl:"list/list.html"}}}).state("school",{url:"/school/{BSN:[0-9]{2}[A-Z][0-9]{2}}",views:{view1:{controller:"SchoolCtrl",templateUrl:"school/school.html"}}}).state("statistics",{url:"/statistics",views:{view1:{controller:"StatisticsCtrl",templateUrl:"statistics/statistics.html"}}}).state("imprint",{url:"/impressum",views:{view1:{controller:"AboutCtrl",templateUrl:"about/about.html"}}})}]),angular.module("berlinerSchulenApp").factory("schoolFactory",["$http","$rootScope",function(a,b){var c={content:null},d={content:null},e={},f=[],g=[],h=[],i={},j=!0;return d.initFilter=function(){return{main:"",street:"",districts:[],schooltypes:[],supporter:[],languages:[],accessibilities:[],courses:[],allDayCare:!1,dual:!1,secEdu:!1}},d.addFilterCallback=function(a,b){f.push({field:a,cb:b})},d.addSchoolCallback=function(a,b){g.push({bsn:a,cb:b})},d.addRunFilterCallback=function(a){h.push(a)},d.setFirstRun=function(a){j=a},d.isFirstRun=function(){return j},d.setFilter=function(a){for(var b in a)switch(b){case"main":d.isFirstRun()?(e.main="tech",d.setFirstRun(!1)):e.main=a.main.toLowerCase();break;case"street":e.street=a.street;break;case"districts":e.districts=a.districts;break;case"supporter":e.supporter=a.supporter;break;case"allDayCare":e.allDayCare=a.allDayCare;break;case"secEdu":e.secEdu=a.secEdu;break;case"dual":e.dual=a.dual;break;case"languages":e.languages=a.languages;break;case"accessibilities":e.accessibilities=a.accessibilities;break;case"courses":e.courses=a.courses;break;case"schooltypes":e.schooltypes=a.schooltypes}return d},d.getFilter=function(){return angular.copy(e)},d.applyFilter=function(){if(null===c.content)return null;var a=c.content.filter(function(a){if(void 0!==a.Schulname){var b=a.Schulname.toLowerCase();if(b.indexOf(e.main)>-1)return!0}return!1}).filter(function(a){return void 0!==a.Strasse&&a.Strasse.indexOf(e.street)>-1?!0:!1}).filter(function(a){if(e.districts.length>0){for(var b in e.districts){var c=e.districts[b].name;if(""!==c&&a.Region.indexOf(c)>-1)return!0}return!1}return!0}).filter(function(a){if(e.supporter.length>0){for(var b in e.supporter){var c=e.supporter[b].name;if(""!==c&&a.Schultraeger.toLowerCase().indexOf(c.toLowerCase())>-1)return!0}return!1}return!0}).filter(function(a){return e.allDayCare===!0?void 0!==a.Ganztagsbetrieb||void 0!==a.spez_Angebote&&a.spez_Angebote.toLowerCase().indexOf("ganztagsschule")>-1?!0:!1:!0}).filter(function(a){return e.secEdu===!0?void 0!==a.ZweiterBildungsweg?!0:!1:!0}).filter(function(a){return e.dual===!0?void 0!==a.DualesLernen?!0:!1:!0}).filter(function(a){if(e.languages.length>0){for(var b in e.languages){var c=e.languages[b].name.toLowerCase();if(""!==c&&void 0!==a.Fremdsprachen)for(var d=a.Fremdsprachen.length-1;d>=0;d--)if(a.Fremdsprachen[d].toLowerCase().indexOf(c)>-1)return!0}return!1}return!0}).filter(function(a){if(e.accessibilities.length>0){for(var b in e.accessibilities){var c=e.accessibilities[b].name.toLowerCase();if(""!==c&&void 0!==a.Bauten)for(var d=a.Bauten.length-1;d>=0;d--)if(a.Bauten[d].toLowerCase().indexOf(c)>-1)return!0}return!1}return!0}).filter(function(a){if(e.courses.length>0){for(var b in e.courses){var c=e.courses[b].name.toLowerCase();if(""!==c&&void 0!==a.Leistungskurse)for(var d=a.Leistungskurse.length-1;d>=0;d--)if(a.Leistungskurse[d].toLowerCase().indexOf(c)>-1)return!0}return!1}return!0}).filter(function(a){if(e.schooltypes.length>0){for(var b in e.schooltypes){var c=e.schooltypes[b].name;if(""!==c&&a.Schulart.indexOf(c)>-1)return!0}return!1}return!0});return d.content=a,d.publishData(),d.isFirstRun()&&d.setFirstRun(!1),d},d.publishData=function(){b.$broadcast("updateSchools",d.content)},d.getJson=function(){a.get("data/data.json").success(function(a){c.content=a,d.content=a,d.applyFilter(),f.length>0&&d.populateFilterChoices(),g.length>0&&d.populateSchoolDetails(),h.length>0&&h.call(this)})},d.populateFilterChoices=function(){for(var a=[],b=f.length-1;b>=0;b--)a.push([]);for(b=c.content.length-1;b>=0;b--)for(var e=f.length-1;e>=0;e--){var g="",h=f[e].field,i=c.content[b];switch(h){case"Region":void 0!==i.Region&&(g=i.Region);break;case"Schultraeger":void 0!==i.Schultraeger&&(g=i.Schultraeger);break;case"Bauten":void 0!==i.Bauten&&(g=i.Bauten);break;case"Leistungskurse":void 0!==i.Leistungskurse&&(g=i.Leistungskurse);break;case"Schulart":void 0!==i.Schulart&&(g=i.Schulart);break;default:g=""}if(g.constructor===Array||a[e].contains(g)){if(g.constructor===Array)for(var j=g.length-1;j>=0;j--)a[e].contains(g[j])||a[e].push(g[j])}else a[e].push(g)}for(b=f.length-1;b>=0;b--)d.saveChoices(f[b].field,a[b]),f[b].cb.call(this,a[b])},d.saveChoices=function(a,b){switch(a){case"Region":i.Region=b;break;case"Schultraeger":i.Schultraeger=b;break;case"Bauten":i.Bauten=b;break;case"Leistungskurse":i.Leistungskurse=b;break;case"Schulart":i.Schulart=b}},d.getChoiceByName=function(a){switch(a){case"Region":return i.Region;case"Schultraeger":return i.Schultraeger;case"Bauten":return i.Bauten;case"Leistungskurse":return i.Leistungskurse;case"Schulart":return i.Schulart;default:return[]}},d.populateSchoolDetails=function(){if(null!==c.content)for(var a=g.length-1;a>=0;a--){var b=g[a].bsn,e=d.getSchoolByBSN(b);g[a].cb.call(this,e)}},d.getSchoolByBSN=function(a){for(var b=c.content.length-1;b>=0;b--)if(c.content[b].bsn===a)return c.content[b];return{}},d.hasData=function(){return null!==c.content},e=d.initFilter(),d.getJson(),d}]),Array.prototype.contains=function(a){for(var b=this.length;b--;)if(this[b]===a)return!0;return!1},angular.module("berlinerSchulenApp").controller("FilterCtrl",["$scope","$timeout","$mdSidenav","schoolFactory","$filter",function(a,b,c,d,e){var f=e("orderBy");a.searchFilter={main:"",street:"",districts:[],schooltypes:[],supporter:[],languages:[],accessibilities:[],courses:[],allDayCare:!1,dual:!1,secEdu:!1},a.loading=!1,a.filter=function(){a.loading=!0,b(function(){d.setFilter(a.searchFilter).applyFilter(),a.loading=!1},600)},a.resetFilter=function(){a.cbDistricts.selectedDistricts=[],a.cbSchooltypes.selectedTypes=[],a.cbSchoolSupporter.selectedSupporter=[],a.cbLanguages.selectedLang=[],a.cbAccessibility.selectedAccessibilities=[],a.cbCourses.selectedCourses=[],a.searchFilter={main:"",street:"",districts:[],schooltypes:[],supporter:[],languages:[],accessibilities:[],courses:[],allDayCare:!1,dual:!1,secEdu:!1},a.filter()},a.cbDistricts={districts:[],selectedDistricts:[],loading:!1,exec:function(b){a.searchFilter.districts=b.newValue,a.filter()},populate:function(b){var c=[];for(var d in b)c.push({name:b[d]});a.cbDistricts.districts=f(c,"name",!1),a.cbDistricts.loading=!1},addCallback:function(){a.cbDistricts.loading=!0,d.addFilterCallback("Region",this.populate)}},a.cbSchooltypes={schooltypes:[],selectedTypes:[],loading:!1,exec:function(b){a.searchFilter.schooltypes=b.newValue,a.filter()},populate:function(b){var c=[];for(var d in b)c.push({name:b[d]});a.cbSchooltypes.schooltypes=f(c,"name",!1),a.cbSchooltypes.loading=!1},addCallback:function(){a.cbSchooltypes.loading=!0,d.addFilterCallback("Schulart",this.populate)}},a.cbSchoolSupporter={supporter:[],selectedSupporter:[],loading:!1,exec:function(b){a.searchFilter.supporter=b.newValue,a.filter()},populate:function(b){var c=[];for(var d in b)c.push({name:b[d]});a.cbSchoolSupporter.supporter=f(c,"name",!1),a.cbSchoolSupporter.loading=!1},addCallback:function(){a.cbSchoolSupporter.loading=!0,d.addFilterCallback("Schultraeger",this.populate)}},a.cbLanguages={languages:[{name:"Arabisch"},{name:"Chinesisch"},{name:"Englisch"},{name:"Französisch"},{name:"Griechisch"},{name:"Hebräisch"},{name:"Italienisch"},{name:"Japanisch"},{name:"Latein"},{name:"Niederländisch"},{name:"Polnisch"},{name:"Portugiesisch"},{name:"Russisch"},{name:"Spanisch"},{name:"Türkisch"}],selectedLang:[],loading:!1,exec:function(b){a.searchFilter.languages=b.newValue,a.filter()},populate:function(b){var c=[];for(var d in b)c.push({name:b[d]});a.cbLanguages.languages=f(c,"name",!1),a.cbLanguages.loading=!1},addCallback:function(){a.cbLanguages.loading=!0,d.addFilterCallback("Fremdsprachen",this.populate)}},a.cbAccessibility={accessibilities:[],selectedAccessibilities:[],loading:!1,exec:function(b){a.searchFilter.accessibilities=b.newValue,a.filter()},populate:function(b){var c=[];for(var d in b)""!==b[d]&&c.push({name:b[d]});a.cbAccessibility.accessibilities=f(c,"name",!1),a.cbAccessibility.loading=!1},addCallback:function(){a.cbAccessibility.loading=!0,d.addFilterCallback("Bauten",this.populate)}},a.cbCourses={courses:[],selectedCourses:[],loading:!1,exec:function(b){a.searchFilter.courses=b.newValue,a.filter()},populate:function(b){var c=[];for(var d in b)""!==b[d]&&c.push({name:b[d]});a.cbCourses.courses=f(c,"name",!1),a.cbCourses.loading=!1},addCallback:function(){a.cbCourses.loading=!0,d.addFilterCallback("Leistungskurse",this.populate)}},this.setSearchFilter=function(b){a.searchFilter=b,a.cbDistricts.selectedDistricts=b.districts,a.cbSchooltypes.selectedTypes=b.schooltypes,a.cbSchoolSupporter.selectedSupporter=b.supporter,a.cbLanguages.selectedLang=b.languages,a.cbAccessibility.selectedAccessibilities=b.accessibilities,a.cbCourses.selectedCourses=b.courses},this.runFilter=function(){if(this.setSearchFilter(d.getFilter()),d.hasData()){var b=d.getChoiceByName("Region");a.cbDistricts.populate(b),b=d.getChoiceByName("Schultraeger"),a.cbSchoolSupporter.populate(b),b=d.getChoiceByName("Bauten"),a.cbAccessibility.populate(b),b=d.getChoiceByName("Leistungskurse"),a.cbCourses.populate(b),b=d.getChoiceByName("Schulart"),a.cbSchooltypes.populate(b),a.filter()}else a.cbDistricts.addCallback(),a.cbSchoolSupporter.addCallback(),a.cbAccessibility.addCallback(),a.cbCourses.addCallback(),a.cbSchooltypes.addCallback(),d.setFilter(a.searchFilter)},this.runFilter()}]),angular.module("berlinerSchulenApp").controller("MapCtrl",["$scope","$rootScope","$timeout","schoolFactory","$window",function(a,b,c,d,e){angular.extend(a,{defaults:{maxZoom:17,scrollWheelZoom:!1,zoomControl:!0,zoomControlPosition:"topright"},layers:{baselayers:{mapbox:{name:"Mapbox",url:"http://api.tiles.mapbox.com/v4/obstschale.kp8hf045/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoib2JzdHNjaGFsZSIsImEiOiJvSFdVbmRRIn0.2aQ9TaMbMbyrAuFQh_icXg",type:"xyz"},osm:{name:"OpenStreetMap",url:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",type:"xyz",layerOptions:{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}}},overlays:{schools:{name:"Schulen",type:"markercluster",visible:!0}}},events:{map:{enable:[],logic:"emit"},marker:{enable:[],logic:"emit"}},berlin:{lat:52.5153601,lng:13.3833154,zoom:11},data:{},icons:{blue_icon:{iconUrl:"assets/img/circle_blue_borderless.svg",iconSize:[15,15],iconAnchor:[7,7],popupAnchor:[0,-5]},orange_icon:{iconUrl:"assets/img/circle_orange_borderless.svg",iconSize:[15,15],iconAnchor:[7,7],popupAnchor:[0,-5]},bluegrey_icon:{iconUrl:"assets/img/circle_bluegrey_borderless.svg",iconSize:[15,15],iconAnchor:[7,7],popupAnchor:[0,-5]},cyan_icon:{iconUrl:"assets/img/circle_cyan_borderless.svg",iconSize:[15,15],iconAnchor:[7,7],popupAnchor:[0,-5]},green_icon:{iconUrl:"assets/img/circle_green_borderless.svg",iconSize:[15,15],iconAnchor:[7,7],popupAnchor:[0,-5]},red_icon:{iconUrl:"assets/img/circle_red_borderless.svg",iconSize:[15,15],iconAnchor:[7,7],popupAnchor:[0,-5]}}});var f=a.$on("updateSchools",function(b,c){function d(a){return a===+a&&a!==(0|a)}a.data.markers={};for(var e=0;e<c.length;e++){var f=null,g=null;if(void 0!==c[e]&&(f=parseFloat(c[e].lat),g=parseFloat(c[e].lon)),d(f)&&d(g)){var h="<strong>"+c[e].Schulname+"</strong><br>";h+=c[e].Strasse+", "+c[e].PLZ+"<br><br>",h+="<em>"+c[e].Schulart+"</em><br>",h+="<a href=#/school/"+c[e].bsn+">Details</a>";var i={lat:f,lng:g,compileMessage:!1,message:h,bsn:c[e].bsn,layer:"schools"};switch(c[e].Schulart){case"Grundschule":i.icon=a.icons.orange_icon;break;case"Integrierte Sekundarschule":i.icon=a.icons.blue_icon;break;case"Gymnasium":i.icon=a.icons.cyan_icon;break;case"Berufsschule":case"Berufsfachschule":case"Berufsschule mit sonderpäd. Aufgaben":case"Kombinierte berufliche Schule":i.icon=a.icons.green_icon;break;default:i.icon=a.icons.bluegrey_icon}a.data.markers[c[e].bsn]=i}}});a.$on("destroy",f);var g=angular.element(e),h=-1;a.getMinMapHeight=function(){return-1===h&&(h=.7*g.height()),h};var i=a.$on("mapCenterRequest",function(a,b,c,d){a.currentScope.berlin.lat=b,a.currentScope.berlin.lng=c;for(var e in a.currentScope.data.markers){var f=a.currentScope.data.markers[e];if(f.bsn===d){f.focus=!0;break}}});a.$on("destroy",i)}]),angular.module("berlinerSchulenApp").controller("ListCtrl",["$scope","$rootScope",function(a,b){function c(a){return a===+a&&a!==(0|a)}a.schools=[],a.pageSize=10,a.currentPage=0,a.centerMap=function(a){var d=parseFloat(a.lat),e=parseFloat(a.lon),f=a.bsn;c(d)&&c(e)&&b.$broadcast("mapCenterRequest",d,e,f)},a.numberOfPages=function(){return Math.ceil(a.schools.length/a.pageSize)};var d=a.$on("updateSchools",function(b,c){a.currentPage=0,a.schools=[];var d=[],f={blue:{src:"assets/img/circle_blue_borderless.svg"},red:{src:"assets/img/circle_red_borderless.svg"},bluegrey:{src:"assets/img/circle_bluegrey_borderless.svg"},cyan:{src:"assets/img/circle_cyan_borderless.svg"},green:{src:"assets/img/circle_green_borderless.svg"},orange:{src:"assets/img/circle_orange_borderless.svg"}};if(c.length>0){for(var g=c.length-1;g>=0;g--){var h={name:c[g].Schulname,district:c[g].Region,street:c[g].Strasse,zip:c[g].PLZ+" Berlin",url:c[g].Internet,type:c[g].Schulart,lat:c[g].lat,lon:c[g].lon,bsn:c[g].bsn};switch(c[g].Schulart){case"Grundschule":h.icon=f.orange;break;case"Integrierte Sekundarschule":h.icon=f.blue;break;case"Gymnasium":h.icon=f.cyan;break;case"Berufsschule":case"Berufsfachschule":case"Berufsschule mit sonderpäd. Aufgaben":case"Kombinierte berufliche Schule":h.icon=f.green;break;default:h.icon=f.bluegrey}d.push(h)}e(d)}});a.$on("destroy",d);var e=function(b){a.schools=b}}]),angular.module("berlinerSchulenApp").filter("startFrom",function(){return function(a,b){return"undefined"!=typeof a&&"undefined"!=typeof b?(b=+b,a.slice(b)):null}}),angular.module("berlinerSchulenApp").controller("AboutCtrl",["$scope","LxDialogService","LxNotificationService",function(a,b,c){a.opendDialog=function(a){b.open(a)},a.closingDialog=function(){c.info("Dialog closed!")}}]),angular.module("berlinerSchulenApp").controller("SchoolCtrl",["$scope","$stateParams","schoolFactory","LxProgressService",function(a,b,c,d){a.loaded=!1,a.err=!1,angular.extend(a,{defaults:{tileLayer:"http://api.tiles.mapbox.com/v4/obstschale.kp8hf045/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoib2JzdHNjaGFsZSIsImEiOiJvSFdVbmRRIn0.2aQ9TaMbMbyrAuFQh_icXg",maxZoom:15,path:{weight:10,color:"#800000",opacity:1},scrollWheelZoom:!1,zoomControl:!1,dragging:!1,touchZoom:!1,doubleClickZoom:!1},berlin:{lat:52.5153601,lng:13.3833154,zoom:15},icons:{blue_icon:{iconUrl:"assets/img/circle_blue.svg",iconSize:[20,20],iconAnchor:[7,7],popupAnchor:[0,-5]},orange_icon:{iconUrl:"assets/img/circle_orange.svg",iconSize:[20,20],iconAnchor:[7,7],popupAnchor:[0,-5]},bluegrey_icon:{iconUrl:"assets/img/circle_bluegrey.svg",iconSize:[20,20],iconAnchor:[7,7],popupAnchor:[0,-5]},cyan_icon:{iconUrl:"assets/img/circle_cyan.svg",iconSize:[20,20],iconAnchor:[7,7],popupAnchor:[0,-5]},green_icon:{iconUrl:"assets/img/circle_green.svg",iconSize:[20,20],iconAnchor:[7,7],popupAnchor:[0,-5]},red_icon:{iconUrl:"assets/img/circle_red.svg",iconSize:[20,20],iconAnchor:[7,7],popupAnchor:[0,-5]}},data:{markers:{m1:{lat:52.5153601,lng:13.3833154,compileMessage:!1,message:"Das ist Berlin. Für den Fall, dass<br>du das noch nicht wusstest :)",icon:{}}}}}),a.school={},a.loadSchool=function(c){if(void 0===c.bsn)return d.circular.hide(),a.school.bsn=b.BSN,a.err=!0,0;a.loaded=!0,d.circular.hide(),a.school=c,a.school.Telefon="(030) "+c.Telefon,a.school.Adresse=c.Strasse+", "+c.PLZ+" Berlin";var e,f;if(void 0!==c.lat||void 0!==c.lon){e=parseFloat(c.lat),f=parseFloat(c.lon),a.berlin.lat=e,a.berlin.lng=f,a.data.markers.m1.lat=e,a.data.markers.m1.lng=f;var g=null;switch(c.Schulart){case"Grundschule":g=a.icons.orange_icon;break;case"Integrierte Sekundarschule":g=a.icons.blue_icon;break;case"Gymnasium":g=a.icons.cyan_icon;break;case"Berufsschule":case"Berufsfachschule":case"Berufsschule mit sonderpäd. Aufgaben":case"Kombinierte berufliche Schule":g=a.icons.green_icon;break;default:g=a.icons.bluegrey_icon}angular.extend(a.data.markers.m1,{icon:g})}},this.addCallback=function(){a.school={};var d=b.BSN;c.addSchoolCallback(d,a.loadSchool)},d.circular.show("#5fa2db","#feedback"),this.addCallback(),c.populateSchoolDetails()}]),angular.module("berlinerSchulenApp").controller("StatisticsCtrl",["$scope","$http",function(a){a.text="More Statistics Comming Soon ..."}]);